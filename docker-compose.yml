version: "3.9"

name: autofinder

networks:
  autofinder-net:
    driver: bridge

volumes:
  mysql_auth_data:
  mysql_autos_data:
  mysql_favoritos_data:

services:
  mysql-auth:
    image: mysql:8.0
    container_name: mysql-auth
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: auth_db
    ports:
      - "3307:3306"
    volumes:
      - mysql_auth_data:/var/lib/mysql
    networks:
      - autofinder-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 10

  mysql-autos:
    image: mysql:8.0
    container_name: mysql-autos
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: autos_db
    ports:
      - "3308:3306"
    volumes:
      - mysql_autos_data:/var/lib/mysql
    networks:
      - autofinder-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 10

  mysql-favoritos:
    image: mysql:8.0
    container_name: mysql-favoritos
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: fav_db
    ports:
      - "3309:3306"
    volumes:
      - mysql_favoritos_data:/var/lib/mysql
    networks:
      - autofinder-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 10

  auth-service:
    build:
      context: ./auth-service
    container_name: auth-service
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - "${AUTH_PORT}:${AUTH_PORT}"
    depends_on:
      mysql-auth:
        condition: service_healthy
    networks:
      - autofinder-net

  auto-service:
    build:
      context: ./auto-service
    container_name: auto-service
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - "${AUTO_PORT}:${AUTO_PORT}"
    depends_on:
      mysql-autos:
        condition: service_healthy
      auth-service:
        condition: service_started
    networks:
      - autofinder-net

  comparador-service:
    build:
      context: ./comparador-service
    container_name: comparador-service
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - "${COMPARADOR_PORT}:${COMPARADOR_PORT}"
    depends_on:
      auto-service:
        condition: service_started
    networks:
      - autofinder-net

  favorito-service:
    build:
      context: ./favorito-service
    container_name: favorito-service
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - "${FAVORITO_PORT}:${FAVORITO_PORT}"
    depends_on:
      mysql-favoritos:
        condition: service_healthy
      auto-service:
        condition: service_started
    networks:
      - autofinder-net

  gateway-service:
    build:
      context: ./gateway-service
    container_name: gateway-service
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - "${GATEWAY_PORT}:${GATEWAY_PORT}"
    depends_on:
      auth-service:
        condition: service_started
      auto-service:
        condition: service_started
      comparador-service:
        condition: service_started
      favorito-service:
        condition: service_started
    networks:
      - autofinder-net
