version: "3.9"

name: autofinder

networks:
  autofinder-net:
    driver: bridge

volumes:
  mysql_auth_data:
  mysql_autos_data:
  mysql_favoritos_data:

services:
  # -------------------------
  # MYSQL: AUTH
  # -------------------------
  mysql-auth:
    image: mysql:8.0
    container_name: mysql-auth
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: auth_db
    ports:
      - "3307:3306"
    volumes:
      - mysql_auth_data:/var/lib/mysql
    networks:
      - autofinder-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 10

  # -------------------------
  # MYSQL: AUTOS
  # -------------------------
  mysql-autos:
    image: mysql:8.0
    container_name: mysql-autos
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: autos_db
    ports:
      - "3308:3306"
    volumes:
      - mysql_autos_data:/var/lib/mysql
    networks:
      - autofinder-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 10

  # -------------------------
  # MYSQL: FAVORITOS
  # -------------------------
  mysql-favoritos:
    image: mysql:8.0
    container_name: mysql-favoritos
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: fav_db
    ports:
      - "3309:3306"
    volumes:
      - mysql_favoritos_data:/var/lib/mysql
    networks:
      - autofinder-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 10

  # -------------------------
  # AUTH-SERVICE
  # -------------------------
  auth-service:
    build:
      context: ./auth-service
    container_name: auth-service
    environment:
      SERVER_PORT: 9030
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-auth:3306/auth_db
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - "9030:9030"
    depends_on:
      mysql-auth:
        condition: service_healthy
    networks:
      - autofinder-net

  # -------------------------
  # AUTO-SERVICE
  # -------------------------
  auto-service:
    build:
      context: ./auto-service
    container_name: auto-service
    environment:
      SERVER_PORT: 9031
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-autos:3306/autos_db
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - "9031:9031"
    depends_on:
      mysql-autos:
        condition: service_healthy
      auth-service:
        condition: service_started
    networks:
      - autofinder-net

  # -------------------------
  # COMPARADOR-SERVICE
  # -------------------------
  comparador-service:
    build:
      context: ./comparador-service
    container_name: comparador-service
    environment:
      SERVER_PORT: 9032
      JWT_SECRET: ${JWT_SECRET}
      # importante: apunta al auto-service por nombre de contenedor
      AUTO_SERVICE_URL: http://auto-service:9031
    ports:
      - "9032:9032"
    depends_on:
      auto-service:
        condition: service_started
    networks:
      - autofinder-net

  # -------------------------
  # FAVORITO-SERVICE
  # -------------------------
  favorito-service:
    build:
      context: ./favorito-service
    container_name: favorito-service
    environment:
      SERVER_PORT: 9033
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-favoritos:3306/fav_db
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      JWT_SECRET: ${JWT_SECRET}
      AUTO_SERVICE_URL: http://auto-service:9031
    ports:
      - "9033:9033"
    depends_on:
      mysql-favoritos:
        condition: service_healthy
      auto-service:
        condition: service_started
    networks:
      - autofinder-net

  # -------------------------
  # GATEWAY-SERVICE
  # -------------------------
  gateway-service:
    build:
      context: ./gateway-service
    container_name: gateway-service
    environment:
      SERVER_PORT: 9000
      JWT_SECRET: ${JWT_SECRET}
      AUTH_SERVICE_URL: http://auth-service:9010
      AUTO_SERVICE_URL: http://auto-service:9011
      COMPARADOR_SERVICE_URL: http://comparador-service:9012
      FAVORITO_SERVICE_URL: http://favorito-service:9013
    ports:
      - "9000:9000"
    depends_on:
      auth-service:
        condition: service_started
      auto-service:
        condition: service_started
      comparador-service:
        condition: service_started
      favorito-service:
        condition: service_started
    networks:
      - autofinder-net
